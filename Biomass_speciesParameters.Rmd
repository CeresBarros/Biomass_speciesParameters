---
title: "LandR _Biomass_speciesParameters_ Manual"
subtitle: "v.`r SpaDES.core::moduleMetadata(module = 'Biomass_speciesParameters', path = '..')$version`"
date: "Last updated: `r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: sandstone
    number_sections: false
    df_print: paged
    keep_md: yes
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 80
bibliography: citations/references_Biomass_speciesParameters.bib
citation-style: citations/ecology-letters.csl
link-citations: true
always_allow_html: true
---

# LandR *Biomass_speciesParameters* Module

<!-- the following are text references used in captions for LaTeX compatibility -->

(ref:Biomass-speciesParameters) *Biomass_speciesParameters*

```{r setup-Biomass-speciesParameters, include=FALSE}
## set cache.rebuild = TRUE whenever there are changes to the module code/metadata
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, warning = FALSE, 
                      cache = 2, cache.rebuild = FALSE, results = "hold", dpi = 300)

## get citation style
if (!file.exists("citations/ecology-letters.csl")) {
  dir.create("citations", showWarnings = FALSE)
  download.file("https://www.zotero.org/styles/ecology-letters?source=1", destfile = "citations/ecology-letters.csl")
}

if (!require(dplyr)) {
  install.packages("dplyr", dependencies = TRUE)
  library(dplyr)
}
```

```{r badgeFigs-Biomass-speciesParameters, include=FALSE, eval = TRUE, cache = FALSE}
dir.create("figures", showWarnings = FALSE)

download.file(url = "https://img.shields.io/badge/Made%20with-Markdown-1f425f.png",
              destfile = "figures/markdownBadge.png",
              mode = 'wb')
download.file(url = "https://img.shields.io/badge/Get%20help-Report%20issues-%3CCOLOR%3E.png",
              destfile = "figures/genericBadge.png",
              mode = 'wb')
```

[![made-with-Markdown](figures/markdownBadge.png)](http://commonmark.org)
[![Generic
badge](figures/genericBadge.png)](https://github.com/PredictiveEcology/Biomass_speciesParameters/issues)

<!-- if knitting to pdf remember to add the pandoc_args: ["--extract-media", "."] option to yml in order to get the badge images -->

**This documentation is work in progress. Potential discrepancies and omissions
may exist for the time being. If you find any, do contact us using the link
above\^\^**

#### Authors:

`r paste(as.character(SpaDES.core::moduleMetadata(module = 'Biomass_speciesParameters', path = '..')$authors), sep = ', ')`
<!-- ideally separate authors with new lines, '\n' not working -->

## Module Overview

### Module summary

This module attempts to calibrate species growth and mortality trait values used
in *Biomass_core*, by matching theoretical species' growth curves obtained with
different trait values (generated by LandR `Biomass_speciesFactorial`; see
[Simulated species data]) against observed growth curves derived from Permanent
Sample Plots (PSP data) across Canada (see [Permanent sample plot data]), to
find the combination of traits that allows a better match to the observed
curves. In particular, it calibrates the `growthcurve`, `mortalityshape`,
`maxANPP` and `maxB` traits (see [Parameter estimation/calibration]).

This module **will not** prepare other traits or parameters used in
*Biomass_core* and so it is meant to be used in conjunction with another data
module which does so (e.g. *Biomass_borealDataPrep*). However, it may be used
stand-alone in an initial phase for easier inspection of the statistical
calibration procedure.

**Note that a Google Account is necessary to access the data.**

As of `r Sys.Date()`, the PSP data needed for this module is not freely
available, and data sharing agreements must be obtained from the governments of
SK, AB, and BC.

### Module inputs and parameters at a glance

*Biomass_speciesParameters* requires an internet connection and authorized
access to the default data used for the calibration (e.g., theoretical species
growth curves and PSD data).

We advise future users to run *Biomass_speciesParameters* with defaults and
inspect what the objects are like before supplying their own data or trying to
run *Biomass_speciesFactorial* to generate their own theoretical curves.

Below are the full lists of input objects (Table
\@ref(tab:moduleInputs-Biomass-speciesParameters)) and parameters (Table
\@ref(tab:moduleParams-Biomass-speciesParameters)) that
*Biomass_speciesParameters* expects. The only inputs that **must** be provided
(i.e., *Biomass_speciesParameters* does not have a default for) is
`studyAreaANPP` (the study area used extract the PSP data from). All other input
objects and parameters have internal defaults, but the user may need to request
access to their online files (see Tables
\@ref(tab:moduleInputs2-Biomass-speciesParameters) and
\@ref(tab:moduleParams2-Biomass-speciesParameters)).

```{r moduleInputs-Biomass-speciesParameters, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_speciesParameters", "..")[, c(1, 3)]  ## name + desc only
knitr::kable(df_inputs,
             caption = "List of (ref:Biomass-speciesParameters) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

```{r moduleParams-Biomass-speciesParameters, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_speciesParameters", "..")[, c(1, 6)] ## name + desc only
knitr::kable(df_params,
             caption = "List of (ref:Biomass-speciesParameters) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

### Events

The following events take place during a *Biomass_speciesParameters* run. Note
that this module only runs once (in one "time step") and only executes one event
(`init`).

-   Module initiation (`init` event): after downloading all the necessary data
    (during the `.inputObjects` event), the module prepares the necessary
    objects and parameters for the simulation and performs the calibration (see
    [Detailed description]).

See [Simulation flow] for further detail.

### Module outputs

The module produces the following outputs (Table
\@ref(tab:moduleOutputs-Biomass-speciesParameters)):

```{r moduleOutputs-Biomass-speciesParameters, echo = FALSE, eval = TRUE, message = FALSE}
df_outputs <- SpaDES.core::moduleOutputs("Biomass_speciesParameters", "..")[, c(1, 3)] ## name + desc only
knitr::kable(df_outputs,
             caption = "List of (ref:Biomass-speciesParameters) output objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

### Links to other modules

Intended to be used with another data module, like *Biomass_borealDataPrep*,
which will prepare all other traits and parameters for *Biomass_core*. You can
see all *potential* module linkages within the LandR ecosystem
[here](https://rpubs.com/PredictiveEcology/LandR_Module_Ecosystem). Select
*Biomass_speciesParameters* from the drop-down menu to see linkages.

### Getting help

-   <https://github.com/PredictiveEcology/Biomass_speciesParameters/issues>

## Module manual

### Detailed description

Tree cohort growth and mortality in *Biomass_core* are essentially determined by
five parameters: `growthcurve`, `mortalityshape`, maximum biomass (`maxB`),
maximum aboveground net primary productivity (`maxANPP`) and `longevity`.

The `growthcurve` and `mortalityshape` parameters (called 'growth curve' and
'mortality shape' in LANDIS-II Biomass Succession Extension v3.2, the base model
for *Biomass_core*) strongly modulate the shape of species growth curves and so
it is important that they are calibrated to the study area in question.

Also, the growth and mortality equations used in *Biomass_core* are non-linear
and their resulting actual biomass accumulation curve is an emergent phenomenon
due to competition effects. This means that the ideal trait/parameter values
cannot be estimated on a single species basis, as their resulting dynamics will
be very different under in a multi-species context.

The *Biomass_speciesParameters* module attempts to address these issues (at
least partially) using a "curve-matching" approach. It compares the best fit 
(according to their AIC) of three non-linear forms (Chapman-Richard's, Compertz,
and a logistic form) fitted to permanent sample plot (PSP) data to a large 
collection of theoretical (simulated) species curves, each representing a different set of 
the five key parameters that govern biomass increment in *Biomass_core*, 
`growthcurve`, `mortalityshape`, the ratio of `maxANPP` to `maxB`, and 
`longevity`. This library of curves is produced by the 
*Biomass_speciesFactorial* module.

The *Biomass_speciesParameters* module generally follows other data modules, 
like *Biomass_boreaDataPrep*, which also attempts to calibrate previously 
estimated spatially varying species traits such as `maxB` and `maxANPP` from the
data layers.

#### Permanent sample plot data

*Biomass_speciesParameters* can use all the PSP data available (note that it may
span several thousands of kilometres), or select the data based on a shapefile
(`studyAreaANPP`; see [Input objects]).

By default, the PSP data are obtained from the National Forest Inventory (NFI),
the Alberta Ministry of Agriculture, the Saskatchewan Ministry of the
Environment, and the British Columbian Ministry of Forests. These data were 
previously treated for errors and standardized into a single data set with the 
exact location and identifying attributes anonymized.

The data include individual species,  diameter at breast height (DBH), and 
sometimes tree height measurements for each tree in a plot, as well as stand 
age. As part of the standardization process, dead trees were removed from the 
dataset. Tree biomass was then estimated using either the DBH-only model or the 
DBH-height from @LambertEtAl2005 per tree species in g/m2. 

Note that the model used to calculate biomass can be changed to @UngEtAl2008 via
the `P(sim)$biomassModel` module parameter.

#### Simulated species data

*Biomass_speciesFactorial* is the module used to create a library of theoretical
species curves (biomass accumulation curves, to be more precise) to which the 
best non-linear model form fit to the PSP-biomass will be matched for each 
species and species combinations in the study area landscape. The library of 
curves are created by running *Biomass_core* with no reproduction, competition, 
disturbance, dispersal effects, on the study area. This cohort data table is the 
table coming out of *Boreal_DataPrep* with each simulation varied in the 
combination of species trait values that influence growth and mortality 
dynamics, namely: `growthcurve`, `mortalityshape`, `longevity` and 
`mANPPproportion`, the ratio of maximum above ground net primary productivity 
(`maxANPP`) to maximum biomass (`maxBiomass`). The values for `maxB` and
`maxANPP` were explored via the `mANPPproportion`, as it reflects their 
relationship. `growthcurve` values  varied from 0 to 1, in  increments of 0.1; 
`mortalityshape` varied from 5 to 25, in increments of 1; longevity varied from
150 to 700 in increments of 25; `mANPPproportion` varied from 0.25 to 10 in 
increments of 0.25.  


This resulted in over 64,000,000 theoretical curves.

Results from these simulations were compiled into a table 
(`cohortDataFactorial`; see [Input objects]) that is accessed by
*Biomass_speciesParameters*, so that the module can be run without needing to
re-simulate the theoretical curves.

#### Parameter estimation/calibration

*Biomass_speciesParameters* calibrates `growthcurve`, `mortalityshape`, `maxB`
and `maxANPP` via `mANPPproportion` by matching the theoretical species curves 
produced by *Biomass_speciesFactorial* (`cohortDataFactorial`) against observed 
species growth curves from permanentsample plot (PSP) data. 

Before calculating the *observed* species growth curves (i.e., the best of three
non-linear form to match PSP data), the module subsets the PSP data to stand 
ages below the 95th percent quantile for all species (this can be changed via 
the `P(sim)$quantileAgeSubset` module parameter), as records for older age 
classes were limited and constituted statistical outliers. In some species, 
changing the quantile value may improve results, however. Two examples
are *Pinus banksiana* and *Populus sp*, for which using the 99th percent
quantile improved the models, because these are short-lived species for which
data at advanced ages is scarce.

In addition, weights are added at the origin (age = 0 and biomass = 0) to
force the intercept to be essentially 0 age and 0 biomass. 

The best fit of three nonlinear form, for each focal species, is then 
calculated. Focal species are defined as either 50% of dominance in the plot or
20% if we are looking to capture the multi-species dynamics (currentyl the 
default). Three model forms are then fit to the observations for the focal 
species: a Chapman-Richard form, a Gompertz form and a Logistic form. Maximum 
likelihood estimation methods are used via the *robustbase::nlrob* for each 
form, and the best model fit is selected via an *AIC*. 

<!-- the three equations below need to be written correctly -->

```{=tex}
#Chapman Richards biomass ~ A * (1 - exp(-k * standAge))^p
#Gompertz biomass ~ A * (exp(-k * exp(-p * standAge)))
#Logistic biomass ~ A / (1 + k * exp(-p * standAge))
\begin{equation} 
  B \sim f_{1}(standAge) + (\sim 1 | measureYear + plotID)
  (\#eq:GAMM)
\end{equation}
```

Species biomass ($B$) is estimated as a function of stand age ($standAge$), with
 the best values of the $A$ abd $k$ parameters to fit the PSP data. 

It is possible that some selected species do not have enough data to allow for
model convergence. In this case, *Biomass_speciesParameters* skips parameter
calibration, and parameter values remain unchanged.

After each species GAMM is calculated, *Biomass_speciesParameters* compares it
to the theoretical curves, and picks the best one based on maximum likelihood.
This best theoretical curve will be associated with a given combination of
`growthcurve`, `mortalityshape` and `maxANPPproportion` values, which are then
used directly as the calibrated values, in case of `growthcurve` and
`mortalityshape`, or to calibrate `maxANPP` in the case of `maxANPPproportion`
(see below).

The user has the option to constrain the values of the `growthcurve` and
`mortalityshape` parameters. By default, `growthcurve` is forced to 0.5,
`mortalityshape` is allowed to vary between 15 and 25, and `mANPPproportion`
between 2.0 and 5.0 (see module parameters `P(sim)$constrainGrowthCurve`,
`P(sim)constrainMortalityShape` and `P(sim)constrainMaxANPP`). These boundary
values were based on preliminary runs and analyses using the default data and
may not apply to other datasets, or to different spatial subsets of the default
data.

If boundary values are used, *Biomass_speciesParameters* subsets the theoretical
species growth curves to those with trait values within the selected boundaries.
Similarly, the module selects only the theoretical curves with longevity values
matching those used in the supplied traits table (`species` input object; see
[Input objects])

Since simulated growth curves never achieve the maximum biomass parameter (the
`maxBiomass` parameter set to 5000 for all simulations of theoretical species
curves, or the `maxB` parameter in *Biomass_core* simulations), it acts as an
asymptotic limit that reflects the potential maximum biomass for a species in an
ecolocation (ecological zone and land cover combination),
*Biomass_speciesParameters* uses uses the relationship between the achieved
maximum biomass to the potential maximum biomass (`maxBiomass`), to rescale the
`maxB` values estimated from data using an upstream module (e.g.
*Biomass_borealDataPrep*). This way, species dynamics simulated in
*Biomass_core* are able to achieve the maximum observed biomasses (used to
*initially* estimate `maxB`).

Finally, the module calibrates `maxANPP` using the `mANPPproportion` value from
the best matching theoretical growth curve as:

```{=tex}
\begin{equation}
  maxB \times \frac{mANPPproportion}{100}
  (\#eq:maxANPPcalib)
\end{equation}
```
where `maxB` is already the calibrated version. In cases where there are not
sufficient PSP data to fit the GAMMs and perform the calibration,
`mANPPproportion` defaults to 3.33, which corresponds to the value used in
LANDIS-II applications in Canada's boreal forests. As already stated above, the
final `maxANPP` value is constrained between 2.0 and 5.0 by default.

### Initialization, inputs and parameters

*Biomass_speciesParameters* initializes itself and prepares all inputs provided
there is an active internet connection and the user has access to the data (and
a Google Account to do so)

#### Input objects

Table \@ref(tab:moduleInputs2-Biomass-speciesParameters) shows the full list of
input objects used by the module.

```{r moduleInputs2-Biomass-speciesParameters, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_speciesParameters", "..")
knitr::kable(df_inputs, 
             caption = "List of (ref:Biomass-speciesParameters) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of these inputs, the following are particularly important and deserve special
attention:

-   **Spatial layers**

    -   `studyAreaANPP` -- shapefile. A `SpatialPolygonsDataFrame` with a single
        polygon determining the where the PSP should be subset to simulation
        will take place. This input object **must be supplied by the user**.

-   **Tables**

    -   `speciesTableFactorial` and `cohortDataFactorial` -- a tables of
        species trait combinations and the theoretical species grwoth curve data
        (respectively)
    -   `PSPmeasure_sppParams`, `PSPplot_sppParams` and `PSPgis_sppParams` -- tree measurement, biomass growth
        and geographical data of the PSP datasets used to buildi observed
        species growth curves.
    -   `species` -- a table of invariant species traits that may have been
        produced by another module. It **must** contain the columns 'species',
        'growthcurve' and 'mortality shape', whose values will be calibrated.
    -   `speciesEcoregion` -- table of spatially-varying species traits that may
        have been produced by another module. It **must** contain the columns
        'speciesCode', 'maxB' and 'maxANPP' and 'ecoregionGroup' (the
        ecolocation ID). 'maxB' and 'maxANPP' values will be calibrated by
        species.

#### Parameters

Table \@ref(tab:moduleParams2-Biomass-speciesParameters) lists all parameters
used in *Biomass_speciesParameters* and their detailed information.

```{r moduleParams2-Biomass-speciesParameters, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_speciesParameters", "..")
knitr::kable(df_params,
             caption = "List of (ref:Biomass-speciesParameters) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of these parameters, the following are particularly important:

-   **Calibration parameters**

    -   `GAMMiterations` and `GAMMknots` -- control the number of iterattions
        and smoother degree used to fit the GAMMs, respectively.

    -   `constrainGrowthCurve`, `constrainMortalityShape` and `constrainMaxANPP`
        -- determine the upper and lower boundaries of the calibrated values of
        `growthcurve`, `mortalityshape` and `maxANPP`, respectively.

-   **Data processing**

    -   `minimumPlotsPerGamm` -- define a minimum number of PSP plots needed to
        fit the GAMMs.

    -   `PSPperiod` -- PSP data period to use.

    -   `quantileAgeSubset` -- upper quantile age value used to subset PSP data.

#### Outputs

-   **Tables**

    -   `species` and `speciesEcoregion` -- tables with calibrated trait values.

    -   `speciesGAMMs` -- the fitted GAMM model objects for each species.

### Simulation flow

The general flow of *Biomass_speciesParameters* processes is:

1.  Preparation of all necessary data and input objects that do not require
    parameter fitting (e.g., the theoretical species growth curve data);

2.  Sub-setting PSP data and calculating the observed species growth curves
    using GAMMs;

3.  Finding the theoretical species growth curve that best matches the observed
    curve, for each species, within curves produced with similar longevity
    values to those in the species traits table (`species`) and with
    `growthcurve` and `mortalityshape` values within the chosen boundaries
    (`P(sim)$constrainGrowthCurve`, `P(sim)$constrainMortalityShape`);

4.  Calibrating `maxB` and `maxANPP`

5.  Adjusting `maxANPP` to match the chosen boundaries
    (`P(sim)$constrainMaxANPP`)

## Usage example

This module can be run stand-alone, but it won't do much more than calibrate
species trait values based on dummy input trait values. We provide an example of
this below, since it may be of value to run the module by itself to become
acquainted with the calibration process and explore the fitted GAMMs. However,
we remind that to run this example you will need a Google Account, and to be
granted access to the data.

A realistic usage example of this module and a few others can be found in [this
repository](https://github.com/CeresBarros/LandRBiomass_publication) and in
@BarrosEtAlinreview.

### Load `SpaDES` and other packages.

```{r load-SpaDES-Biomass-speciesParameters}
if (!require(Require)) {
  install.packages("Require")
  library(Require)
}

Require(c("PredictiveEcology/SpaDES.install",
          "SpaDES", "PredictiveEcology/SpaDES.core@development"), 
        install_githubArgs = list(dependencies = TRUE))
```

### Get module, necessary packages and set up folder directories

```{r module usage example pkg-Biomass-speciesParameters, eval = FALSE}
tempDir <- tempdir()

paths <- list(inputPath = normPath(file.path(tempDir, "inputs")), 
              cachePath = normPath(file.path(tempDir, "cache")), 
              modulePath = normPath(file.path(tempDir, "modules")), 
              outputPath = normPath(file.path(tempDir, "outputs")))

getModule("PredictiveEcology/Biomass_speciesParameters@79896a4e3b785e34e5f509798ab6c2204bb334d7", modulePath = paths$modulePath, overwrite = TRUE)

## make sure all necessary packages are installed:
makeSureAllPackagesInstalled(paths$modulePath)
```

### Setup simulation

```{r module usage example setup-Biomass-speciesParameters, eval = FALSE}
library(SpaDES)

times <- list(start = 0, end = 1)

modules <- list("Biomass_speciesParameters")

#the purpose of this table is experiment with modify longevity - longevity is not estimated by the module
#but it is used in trait estimation. 
inputSpecies <- data.table(species = c("Abie_bal", 'Abie_las', 'Betu_pap', 'Lari_lar',
                                        'Pice_eng', 'Pice_gla', 'Pice_mar', 'Pinu_ban',
                                       'Pinu_con', 'Pseu_men', "Popu_tre"),
                           longevity = c(300, 300, 170, 170, 330, 250, 250, 175, 300, 600, 200),
                           mortalityshape = 15, growthcurve = 0)
objects <- list(species = inputSpecies)

inputs <- list()
outputs <- list()

parameters <- list(Biomass_speciesParameters = 
                     list(GAMMiterations = 2, 
                          GAMMknots = list(
                            "Abie_bal" = 3,
                            "Abie_las" = 3,
                            "Betu_pap" = 3,
                            "Lari_lar" = 4,
                            "Pice_eng" = 4,
                            "Pice_gla" = 3,
                            "Pice_mar" = 4,
                            "Pinu_ban" = 3,
                            "Pinu_con" = 4, 
                            "Popu_tre" = 4,
                            "Pseu_men" = 3),
                          minimumPlotsPerGamm = 40,
                          constrainMortalityShape = list(
                            "Abie_bal" = c(15,25),
                            "Abie_las" = c(15,25),
                            "Betu_pap" = c(15,20),
                            "Lari_lar" = c(20,25),
                            "Pice_eng" = c(20,25),
                            "Pice_gla" = c(20,25),
                            "Pice_mar" = c(15,25),
                            "Pinu_ban" = c(15,25),
                            "Pinu_con" = c(15,25), 
                            "Popu_tre" = c(20,25),
                            "Pseu_men" = c(20,25)
                          ),
                          constrainGrowthCurve = list(
                            "Abie_bal" = c(0, 1),
                            "Abie_las" = c(0, 1),
                            "Betu_pap" = c(0, 1),
                            "Lari_lar" = c(0, 1),
                            "Pice_eng" = c(0, 1),
                            "Pice_gla" = c(0, 1),
                            "Pice_mar" = c(0, 1),
                            "Pinu_ban" = c(0, 1),
                            "Pinu_con" = c(0, 1), 
                            "Popu_tre" = c(0, 1),
                            "Pseu_men" = c(0, 1)
                          ),
                          quantileAgeSubset = list(
                            "Abie_bal" = 95, 
                            "Abie_las" = 95,
                            "Betu_pap" = 95,
                            "Lari_lar" = 95,
                            "Pice_eng" = 95,
                            "Pice_gla" = 95,
                            "Pice_mar" = 95,
                            "Pinu_ban" = 95,
                            "Pinu_con" = 99, 
                            "Popu_tre" = 99,
                            "Pseu_men" = 99
                          )
                     ))


mySim <- simInitAndSpades(times = times, 
                          params = parameters, 
                          modules = modules, 
                          paths = paths, 
                          objects = objects)

## to inspect the fitted GAMM models:
mySim$speciesGAMMs$Pice_mar
```

## References
